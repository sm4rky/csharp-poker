@using PokerAppFrontend.Enums
@using PokerAppFrontend.Models

<div class="relative w-full aspect-[5/2]">
    <div class="absolute inset-0 rounded-full
                border-[1rem] lg:border-[2rem] border-muted-foreground
                shadow-2xl pointer-events-none z-20">
    </div>

    <div class="absolute inset-0 rounded-full bg-foreground overflow-hidden">
        <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2">
            <Community Cards="Table.Community" Street="@ParseStreet(Table.Street)"/>
        </div>
    </div>

    <div class="absolute inset-0 rounded-full z-20">
        @{
            var seats = BuildSeatNumberArray(Table.Players.Count);
            var seatToPlayer = new PlayerDto?[6];
            var isShowdown = (ShowdownResult is not null) || (CurrentStreet == Street.Showdown);
            for (var i = 0; i < Table.Players.Count && i < seats.Length; i++)
            {
                var seatNumber = seats[i];
                var player = isShowdown
                    ? ShowdownResult?.Hands.FirstOrDefault(h => h.Player.SeatIndex == i)?.Player
                    : Table.Players.FirstOrDefault(p => p.SeatIndex == i);
                if (seatNumber is >= 0 and < 6) seatToPlayer[seatNumber] = player;
            }
        }

        @for (var seat = 0; seat < 6; seat++)
        {
            var player = seatToPlayer[seat];
            var seatIndex = player?.SeatIndex;
            var handValue = ShowdownResult is not null
                ? GetShowdownHandRankBySeatIndex(seatIndex)
                : HandRank.Unknown;

            <PlayerSeat
                SeatNumber="seat"
                Player="player"
                IsDealer="@(seatIndex == Table.Dealer)"
                IsSmallBlind="@(seatIndex == Table.SmallBlind)"
                IsBigBlind="@(seatIndex == Table.BigBlind)"
                IsCurrentSeatToAct="@(seatIndex == Table.CurrentSeatToAct)"
                Street="@CurrentStreet"
                HandRank="handValue"
            />
        }
    </div>
</div>

@code {
    [Parameter] public required TableDto Table { get; set; } = null!;
    [Parameter] public ReadyInfoDto? ReadyInfo { get; set; }
    [Parameter] public ShowdownResultDto? ShowdownResult { get; set; }
    [Parameter] public DefaultWinResultDto? DefaultWinResult { get; set; }

    private Street CurrentStreet
    {
        get => ParseStreet(Table?.Street ?? "");
        set => throw new NotImplementedException();
    }

    private static Street ParseStreet(string? street)
    {
        if (string.IsNullOrWhiteSpace(street)) return Street.Unknown;
        var s = street.Trim().ToLowerInvariant();
        return s switch
        {
            "waiting" => Street.Waiting,
            "preflop" => Street.PreFlop,
            "flop" => Street.Flop,
            "turn" => Street.Turn,
            "river" => Street.River,
            "showdown" => Street.Showdown,
            _ => Street.Unknown
        };
    }

    private static HandRank ParseHandRank(string? handRank)
    {
        if (string.IsNullOrWhiteSpace(handRank)) return HandRank.Unknown;
        var hr = handRank.Trim().ToLowerInvariant();
        return hr switch
        {
            "highcard" => HandRank.HighCard,
            "onepair" => HandRank.OnePair,
            "twopair" => HandRank.TwoPair,
            "threeofakind" => HandRank.ThreeOfAKind,
            "straight" => HandRank.Straight,
            "flush" => HandRank.Flush,
            "fullhouse" => HandRank.FullHouse,
            "fourofakind" => HandRank.FourOfAKind,
            "straightflush" => HandRank.StraightFlush,
            _ => HandRank.Unknown
        };
    }

    private static int[] BuildSeatNumberArray(int count) => count switch
    {
        <= 0 => [],
        1 => [0],
        2 => [0, 3],
        3 => [0, 2, 3],
        4 => [0, 2, 3, 5],
        5 => [0, 2, 3, 4, 5],
        _ => [0, 1, 2, 3, 4, 5],
    };

    private HandRank GetShowdownHandRankBySeatIndex(int? seatIndex)
    {
        if (seatIndex is null || ShowdownResult?.Hands is null) return HandRank.Unknown;

        var hand = ShowdownResult.Hands
            .FirstOrDefault(h => h.Player?.SeatIndex == seatIndex.Value);

        return hand is null ? HandRank.Unknown : ParseHandRank(hand.HandRank);
    }

}